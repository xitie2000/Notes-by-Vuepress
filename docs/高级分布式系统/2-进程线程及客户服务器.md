# chapter 2 进程线程及客户服务器

## 1 进程

### 1.1 简介

进程是一个具有一定独立功能的程序关于某个数据集合的一次运行活动

- 进程是系统资源分配的基本单元
- 在早期面向进程设计的计算机结构中，是系统基本的执行单元或者说调度单元
- 在当代面向线程设计的计算机结构中，是线程的容器

多个不同的进程运行的可以是相同的程序：一个程序在不同的数据集里就构成不同的进程，能得到不同的结果；但是执行过程中，程序一般不发生改变

### 1.2 五状态进程模型

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/12632/20221029164705.png)

### 1.3 进程的特点

- 动态性：进程的实质是程序在多道程序系统中的一次执行过程，进程是动态产生，动态消亡的
- 并发性：任何进程都可以同其他进程一起并发执行
- 独立性：进程是一个能独立运行的基本单位，同时也是系统分配资源和调度的独立单位
- 异步性：由于进程间的相互制约，使进程具有执行的间断性，即进程按各自独立的、不可预知的速度向前推进
- 结构特征：进程由程序、数据和进程控制块三部分组成

## 2 线程

### 2.1 线程的引入

- 进程的引入提高了计算机资源的利用效率。但在进一步提高进程的并发性时，人们发现进程切换开销占的比重越来越大，同时进程间通信的效率也受到限制
- 线程的引入正是为了简化进程间的通信，降低运行实体间切换的开销，提高进程内的并发程度
- 线程：有时称轻量级进程，进程中的一个运行实体，是一个CPU调度单位，资源的拥有者还是进程
- 多线程进程：一个线程被阻塞时，可运行同一进 程中的另一线程

### 2.2 线程模型

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/12632/20221029165539.png)

### 2.3 线程编程

```java
public class MyThread extends Thread {
    int count = 1, number;
    public MyThread(int num) {
        number = num;
        System.out.println("Create thread" + number);
    }
    public void run() {
        while (true) {
            System.out.println("Thread " + number + ":count " + count);
            if (++count == 6) return;
        }
    }
    public static void main(String args[]) {
        for (int i = 0; i < 5; i++) new MyThread(i + 1).start();
    }
}
```

第一次运行

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/12632/20221029170632.png)

第二次运行

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/12632/20221029170741.png)

### 2.4 理解线程

- 线程是进程的一个实体，可作为系统独立调度的基本单位
  - 有执行状态（状态转换：阻塞、就绪、运行）
  - 不运行时保存上下文:每个线程有自己的程序计数器、堆栈（局部变量）、状态等
- 调度：线程作为调度的基本单位，同进程中线程切换不引起进程切换，当不同进程的线程切换才引起进程切换
  - 线程间切换时，系统开销小、切换快
- 并发性：一个进程内的多个线程可并发
- 拥有资源：线程仅拥有隶属进程的资源；进程是拥有资源的独立单位
  - 进程的多个线程都在该进程的地址空间活动，可共享该进程的资源

### 2.5 使用线程的优点和应用场合

- 线程间切换时，系统开销小、切换快
- 线程间共享进程资源，通信方便
- 适宜的应用场合
  - 非计算密集型任务，有比较多的IO操作
    - 如：接收数据、处理数据、备份数据可考虑设计3个控制线程，不会因为某个线程阻塞，导致整个进程被阻塞
  - 有多核CPU
  - 进程间通信代价太大
  - 需要并发
- **线程的数量也不是越多越好，合适最好**

### 2.6 线程池

- 虽然线程的创建成本比较低，但也需要空间的初始化工作等，还是有一定的开销
- 线程池就是一个存放线程的池子，当需要线程时可以从池中取出线程，当不需要线程时将线程放还池中
  - 实现了线程的重复利用，减少了线程频繁创建和销毁带来的开销
- 相似概念：数据库的连接池

### 2.7 线程与并发

- 线程允许在同一个进程中同时存在多个线程控制流，每个线程有各自的程序计数器、栈和局部变量，同一个程序中的多个线程可以被同时调度到多个CPU上运行
- 当多个线程要争夺资源的时候，就需要进行并发控制，如
  - 锁机制：`synchronized(object){ }`
- 并发与并行：并发是同一时间应对（dealing with）多件事情的能力，宏观上同时，微观上不断切换；并行是同一时间动手做（doing）多件事情的能力，宏观和微观都是同时

### 2.8 多进程与多线程

- 对需要利用多核性能又想实现资源完全隔离的情况，选择多进程
- 对需要利用多核性能但不要实现资源完全隔离的情况，选择多线程
- 对希望提升核内CPU利用率的情况，则选择多协程（纤程）

### 2.9 使用例

#### 2.9.1 客户程序中的多线程

- 以web浏览器为例，web文档由HTML文件组成，包含文本文件、图像组、图标等，须建立TCP/IP的连接，建立连接和读取数据都可能导致阻塞
- 以多线程的方式开发浏览器，激活多个线程，每个线程都与服务器建立独立连接获取数据，每个线程负责获取页面的相应部分

#### 2.9.2 Server侧的多线程

如多线程的Web服务器

![](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/12632/20221029172633.png)

### 2.10 提醒

- 由于线程并不像进程那样彼此隔离，在单个进程中共享资源的并发控制问题由应用程序开发者负责解决
- 因此多线程应用程序的开发需要付出更多的努力
- 设计要合理，实现要简单

